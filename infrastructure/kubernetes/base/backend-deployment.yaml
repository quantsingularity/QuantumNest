apiVersion: apps/v1
kind: Deployment
metadata:
    name: quantumnest-backend
    namespace: quantumnest-prod
    labels:
        app: quantumnest-backend
        version: v1.0.0
        tier: backend
        component: api-server
        app.kubernetes.io/name: quantumnest-backend
        app.kubernetes.io/instance: quantumnest-backend-prod
        app.kubernetes.io/version: '1.0.0'
        app.kubernetes.io/component: backend
        app.kubernetes.io/part-of: quantumnest-platform
        app.kubernetes.io/managed-by: argocd
        security.quantumnest.com/data-classification: confidential
        compliance.quantumnest.com/pci-dss: 'true'
        compliance.quantumnest.com/sox: 'true'
    annotations:
        deployment.kubernetes.io/revision: '1'
        argocd.argoproj.io/sync-wave: '2'
        config.kubernetes.io/local-config: 'false'
        security.quantumnest.com/scan-date: '2024-01-15T10:30:00Z'
        security.quantumnest.com/vulnerability-scan: 'passed'
        compliance.quantumnest.com/last-audit: '2024-01-10T09:00:00Z'
spec:
    replicas: 3
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxUnavailable: 1
            maxSurge: 1
    selector:
        matchLabels:
            app: quantumnest-backend
            tier: backend
    template:
        metadata:
            labels:
                app: quantumnest-backend
                version: v1.0.0
                tier: backend
                component: api-server
                security.quantumnest.com/data-classification: confidential
                network-policy: quantumnest-backend
            annotations:
                prometheus.io/scrape: 'true'
                prometheus.io/port: '8080'
                prometheus.io/path: '/metrics'
                vault.hashicorp.com/agent-inject: 'true'
                vault.hashicorp.com/role: 'quantumnest-backend'
                vault.hashicorp.com/agent-inject-secret-database: 'secret/data/database/prod/quantumnest'
                vault.hashicorp.com/agent-inject-template-database: |
                    {{- with secret "secret/data/database/prod/quantumnest" -}}
                    export DATABASE_URL="postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@{{ .Data.data.host }}:{{ .Data.data.port }}/{{ .Data.data.database }}?sslmode=require"
                    {{- end }}
                co.elastic.logs/enabled: 'true'
                co.elastic.logs/json.keys_under_root: 'true'
                co.elastic.logs/json.add_error_key: 'true'
                co.elastic.logs/json.message_key: 'message'
        spec:
            serviceAccountName: quantumnest-backend-sa
            automountServiceAccountToken: true
            securityContext:
                runAsNonRoot: true
                runAsUser: 10001
                runAsGroup: 10001
                fsGroup: 10001
                seccompProfile:
                    type: RuntimeDefault
                supplementalGroups: [10001]
            affinity:
                podAntiAffinity:
                    preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                              labelSelector:
                                  matchExpressions:
                                      - key: app
                                        operator: In
                                        values:
                                            - quantumnest-backend
                              topologyKey: kubernetes.io/hostname
                nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                            - matchExpressions:
                                  - key: node-type
                                    operator: In
                                    values:
                                        - application
                                  - key: security-zone
                                    operator: In
                                    values:
                                        - restricted
            tolerations:
                - key: 'quantumnest.com/financial-workload'
                  operator: 'Equal'
                  value: 'true'
                  effect: 'NoSchedule'
            containers:
                - name: quantumnest-backend
                  image: quantumnest/backend:1.0.0-secure
                  imagePullPolicy: Always
                  securityContext:
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      runAsNonRoot: true
                      runAsUser: 10001
                      runAsGroup: 10001
                      capabilities:
                          drop:
                              - ALL
                      seccompProfile:
                          type: RuntimeDefault
                  ports:
                      - name: http
                        containerPort: 8080
                        protocol: TCP
                      - name: https
                        containerPort: 8443
                        protocol: TCP
                      - name: metrics
                        containerPort: 9090
                        protocol: TCP
                      - name: health
                        containerPort: 8081
                        protocol: TCP
                  env:
                      - name: ENVIRONMENT
                        value: 'production'
                      - name: LOG_LEVEL
                        value: 'INFO'
                      - name: METRICS_ENABLED
                        value: 'true'
                      - name: TRACING_ENABLED
                        value: 'true'
                      - name: JAEGER_ENDPOINT
                        value: 'https://jaeger-collector.quantumnest-monitoring.svc.cluster.local:14268/api/traces'
                      - name: VAULT_ADDR
                        value: 'https://vault.quantumnest.internal:8200'
                      - name: VAULT_NAMESPACE
                        value: 'quantumnest'
                      - name: TLS_CERT_PATH
                        value: '/etc/tls/tls.crt'
                      - name: TLS_KEY_PATH
                        value: '/etc/tls/tls.key'
                      - name: CA_CERT_PATH
                        value: '/etc/tls/ca.crt'
                      - name: ENCRYPTION_KEY_PATH
                        value: '/vault/secrets/encryption-key'
                      - name: JWT_SECRET_PATH
                        value: '/vault/secrets/jwt-secret'
                  envFrom:
                      - configMapRef:
                            name: quantumnest-backend-config
                      - secretRef:
                            name: quantumnest-backend-secrets
                  resources:
                      requests:
                          memory: '512Mi'
                          cpu: '250m'
                          ephemeral-storage: '1Gi'
                      limits:
                          memory: '2Gi'
                          cpu: '1000m'
                          ephemeral-storage: '2Gi'
                  volumeMounts:
                      - name: tls-certs
                        mountPath: /etc/tls
                        readOnly: true
                      - name: vault-secrets
                        mountPath: /vault/secrets
                        readOnly: true
                      - name: tmp
                        mountPath: /tmp
                      - name: var-cache
                        mountPath: /var/cache
                      - name: var-log
                        mountPath: /var/log
                  livenessProbe:
                      httpGet:
                          path: /health/live
                          port: health
                          scheme: HTTP
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3
                      successThreshold: 1
                  readinessProbe:
                      httpGet:
                          path: /health/ready
                          port: health
                          scheme: HTTP
                      initialDelaySeconds: 10
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 3
                      successThreshold: 1
                  startupProbe:
                      httpGet:
                          path: /health/startup
                          port: health
                          scheme: HTTP
                      initialDelaySeconds: 10
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 30
                      successThreshold: 1
                - name: istio-proxy
                  image: istio/proxyv2:1.19.0
                  securityContext:
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      runAsNonRoot: true
                      runAsUser: 1337
                      runAsGroup: 1337
                      capabilities:
                          drop:
                              - ALL
                          add:
                              - NET_ADMIN
                              - NET_RAW
                  resources:
                      requests:
                          memory: '128Mi'
                          cpu: '100m'
                      limits:
                          memory: '256Mi'
                          cpu: '200m'
            volumes:
                - name: tls-certs
                  secret:
                      secretName: quantumnest-backend-tls
                      defaultMode: 0400
                - name: vault-secrets
                  emptyDir:
                      medium: Memory
                      sizeLimit: 64Mi
                - name: tmp
                  emptyDir:
                      sizeLimit: 1Gi
                - name: var-cache
                  emptyDir:
                      sizeLimit: 1Gi
                - name: var-log
                  emptyDir:
                      sizeLimit: 1Gi
            imagePullSecrets:
                - name: quantumnest-registry-secret
            dnsPolicy: ClusterFirst
            restartPolicy: Always
            terminationGracePeriodSeconds: 30
            priorityClassName: quantumnest-high-priority
            nodeSelector:
                node-type: application
                security-zone: restricted
---
apiVersion: v1
kind: Service
metadata:
    name: quantumnest-backend-service
    namespace: quantumnest-prod
    labels:
        app: quantumnest-backend
        tier: backend
        app.kubernetes.io/name: quantumnest-backend
        app.kubernetes.io/component: backend
        app.kubernetes.io/part-of: quantumnest-platform
    annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: nlb
        service.beta.kubernetes.io/aws-load-balancer-ssl-cert: arn:aws:acm:us-west-2:123456789012:certificate/12345678-1234-1234-1234-123456789012
        service.beta.kubernetes.io/aws-load-balancer-ssl-ports: 'https'
        service.beta.kubernetes.io/aws-load-balancer-backend-protocol: http
        service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: 'true'
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        prometheus.io/path: '/metrics'
spec:
    type: ClusterIP
    selector:
        app: quantumnest-backend
        tier: backend
    ports:
        - name: http
          port: 80
          targetPort: 8080
          protocol: TCP
        - name: https
          port: 443
          targetPort: 8443
          protocol: TCP
        - name: metrics
          port: 9090
          targetPort: 9090
          protocol: TCP
    sessionAffinity: None
---
apiVersion: v1
kind: ConfigMap
metadata:
    name: quantumnest-backend-config
    namespace: quantumnest-prod
    labels:
        app: quantumnest-backend
        app.kubernetes.io/name: quantumnest-backend
        app.kubernetes.io/component: backend
data:
    APP_NAME: 'QuantumNest Backend'
    APP_VERSION: '1.0.0'
    ENVIRONMENT: 'production'
    LOG_FORMAT: 'json'
    LOG_LEVEL: 'INFO'
    METRICS_PORT: '9090'
    HEALTH_PORT: '8081'
    CORS_ENABLED: 'true'
    CORS_ORIGINS: 'https://app.quantumnest.com,https://admin.quantumnest.com'
    RATE_LIMIT_ENABLED: 'true'
    RATE_LIMIT_REQUESTS_PER_MINUTE: '1000'
    SESSION_TIMEOUT_MINUTES: '30'
    JWT_EXPIRY_HOURS: '24'
    ENCRYPTION_ALGORITHM: 'AES-256-GCM'
    DATABASE_POOL_SIZE: '20'
    DATABASE_MAX_CONNECTIONS: '100'
    DATABASE_CONNECTION_TIMEOUT: '30'
    REDIS_POOL_SIZE: '10'
    REDIS_CONNECTION_TIMEOUT: '5'
    AUDIT_LOGGING_ENABLED: 'true'
    COMPLIANCE_MODE: 'strict'
    PCI_DSS_ENABLED: 'true'
    SOX_COMPLIANCE: 'true'
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
    name: quantumnest-backend-pdb
    namespace: quantumnest-prod
    labels:
        app: quantumnest-backend
spec:
    minAvailable: 2
    selector:
        matchLabels:
            app: quantumnest-backend
            tier: backend
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
    name: quantumnest-backend-hpa
    namespace: quantumnest-prod
    labels:
        app: quantumnest-backend
spec:
    scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: quantumnest-backend
    minReplicas: 3
    maxReplicas: 20
    metrics:
        - type: Resource
          resource:
              name: cpu
              target:
                  type: Utilization
                  averageUtilization: 70
        - type: Resource
          resource:
              name: memory
              target:
                  type: Utilization
                  averageUtilization: 80
        - type: Pods
          pods:
              metric:
                  name: http_requests_per_second
              target:
                  type: AverageValue
                  averageValue: '100'
    behavior:
        scaleDown:
            stabilizationWindowSeconds: 300
            policies:
                - type: Percent
                  value: 10
                  periodSeconds: 60
        scaleUp:
            stabilizationWindowSeconds: 60
            policies:
                - type: Percent
                  value: 50
                  periodSeconds: 60
                - type: Pods
                  value: 2
                  periodSeconds: 60
